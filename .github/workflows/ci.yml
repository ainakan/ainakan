name: CI

on: push

env:
  AINAKAN_COMPILER_MOD: subprojects/ainakan-core/src/compiler/go.mod
  ANDROID_NDK_VERSION: r25b

jobs:
  publish-prod:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs:
      - package-windows
      - package-windows-sfx
      - package-macos
      - package-linux
      - package-ios
      - package-watchos
      - package-tvos
      - package-android
      - package-qnx
      - package-apple-universal
      - assemble-ios-assets
      - assemble-tvos-assets
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab needed submodules
        run: python tools/ensure-submodules.py ainakan-gum ainakan-core ainakan-python ainakan-node
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro
          sudo npm install -g cloudflare-cli
      - name: Download release assets
        uses: actions/download-artifact@v4
        with:
          pattern: release-asset-*
          merge-multiple: true
          path: build/release-assets/
      - name: Download Node-API prebuilds for Windows/x86_64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-windows-x86_64
          path: build/release-assets/
      - name: Download Node-API prebuilds for Windows/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-windows-arm64
          path: build/release-assets/
      - name: Download Node-API prebuilds for macOS/x86_64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-macos-x86_64
          path: build/release-assets/
      - name: Download Node-API prebuilds for macOS/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-macos-arm64
          path: build/release-assets/
      - name: Download Node-API prebuilds for Linux/x86
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-linux-x86
          path: build/release-assets/
      - name: Download Node-API prebuilds for Linux/x86_64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-linux-x86_64
          path: build/release-assets/
      - name: Download Node-API prebuilds for Linux/armhf
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-linux-armhf
          path: build/release-assets/
      - name: Download Node-API prebuilds for Linux/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-node-linux-arm64
          path: build/release-assets/
      - name: Package iOS assets
        uses: ./.github/actions/package-ios-assets
      - name: Package tvOS assets
        uses: ./.github/actions/package-tvos-assets
      - name: Package Cirrus CI artifacts
        run: .github/scripts/package-cirrus-ci-artifacts.sh ${{ github.sha }}
      - name: Rename release assets
        run: .github/scripts/rename-release-assets.sh
      - name: Publish release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          name: "Ainakan ${{ env.AINAKAN_VERSION }}"
          body: "See https://ainakan.re/news/ for details."
          files: build/release-assets/*
      - name: Prepare Python packages
        uses: ./.github/actions/prepare-python-packages
      - name: Publish Python bindings to pypi.org
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: build/python-packages/
      - name: Publish .deb packages
        uses: ./.github/actions/publish-debs
        with:
          site: production
      - name: Setup npm authentication
        uses: actions/setup-node@v4
        with:
          registry-url: "https://registry.npmjs.org"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Publish Node.js bindings to npm
        run: |
          export AINAKAN_DEPS=$PWD/deps
          cd subprojects/ainakan-node/subprojects
          ln -s ../../ainakan-gum .
          ln -s ../../ainakan-core .
          cd ..
          git submodule update --init --recursive
          npm version $AINAKAN_VERSION
          ./configure -- -Dainakan-core:compat=disabled
          make
          npm install
          npm publish
      - name: Publish ainakan-gadget-ios to npm
        run: |
          cd releng/modules/ainakan-gadget-ios
          npm version $AINAKAN_VERSION
          npm publish
      - name: Trigger magisk-ainakan CI
        run: |
          curl \
              -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.MAGISK_AINAKAN_TOKEN }}" \
              https://api.github.com/repos/ViRb3/magisk-ainakan/dispatches \
              -d '{"event_type":"build"}'

  publish-dev:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs:
      - ainakan-windows
      - ainakan-macos
      - ainakan-linux
      - assemble-ios-assets
      - assemble-tvos-assets
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab needed submodules
        run: python tools/ensure-submodules.py ainakan-core ainakan-python
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro
          sudo npm install -g cloudflare-cli
      - name: Package iOS assets
        uses: ./.github/actions/package-ios-assets
      - name: Package tvOS assets
        uses: ./.github/actions/package-tvos-assets
      - name: Prepare Python packages
        uses: ./.github/actions/prepare-python-packages
      - name: Publish Python bindings to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          packages-dir: build/python-packages/
          repository-url: https://test.pypi.org/legacy/
      - name: Publish .deb packages
        uses: ./.github/actions/publish-debs
        with:
          site: development

  assemble-ios-assets:
    runs-on: macos-latest
    needs: ainakan-ios
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Download universal ainakan-server for iOS/arm64(e)
        uses: actions/download-artifact@v4
        with:
          name: ainakan-server-ios-arm64e
          path: ios-arm64e/
      - name: Create universal ainakan-server for iOS
        run: |
          lipo ios-arm64e/ainakan-server -thin arm64 -output ainakan-server-arm64
          lipo ios-arm64e/ainakan-server -thin arm64e -output ainakan-server-arm64e
          for arch in arm64 arm64e; do
            codesign -f -s "-" --preserve-metadata=entitlements ainakan-server-$arch
          done
          ./releng/mkfatmacho.py \
              ainakan-server-ios-universal \
              ainakan-server-arm64 \
              ainakan-server-arm64e
      - name: Download universal ainakan-agent for iOS/arm64(e)
        uses: actions/download-artifact@v4
        with:
          name: ainakan-agent-ios-arm64e
          path: ios-arm64e/
      - name: Sign universal ainakan-agent for iOS/arm64(e)
        run: codesign -f -s "-" ios-arm64e/ainakan-agent.dylib
      - name: Assemble iOS assets
        run: |
          mkdir -p ios-assets/usr/bin ios-assets/usr/lib/ainakan
          mv ainakan-server-ios-universal ios-assets/usr/bin/ainakan-server
          mv ios-arm64e/ainakan-agent.dylib ios-assets/usr/lib/ainakan/ainakan-agent.dylib
      - name: Upload iOS assets
        uses: actions/upload-artifact@v4
        with:
          name: ios-assets
          path: ios-assets/*

  assemble-tvos-assets:
    runs-on: macos-latest
    needs: ainakan-tvos
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Download ainakan-server for tvOS/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-server-tvos-arm64
          path: tvos-arm64/
      - name: Prepare ainakan-server for tvOS/arm64
        run: codesign -f -s "-" --preserve-metadata=entitlements tvos-arm64/ainakan-server
      - name: Download ainakan-agent for tvOS/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-agent-tvos-arm64
          path: tvos-arm64/
      - name: Prepare ainakan-agent for tvOS/arm64
        run: codesign -f -s "-" tvos-arm64/ainakan-agent.dylib
      - name: Assemble tvOS assets
        run: |
          mkdir -p tvos-assets/usr/bin tvos-assets/usr/lib/ainakan
          mv tvos-arm64/ainakan-server tvos-assets/usr/bin/ainakan-server
          mv tvos-arm64/ainakan-agent.dylib tvos-assets/usr/lib/ainakan/ainakan-agent.dylib
      - name: Upload tvOS assets
        uses: actions/upload-artifact@v4
        with:
          name: tvos-assets
          path: tvos-assets/*

  package-apple-universal:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: macos-latest
    needs: [ainakan-macos, ainakan-ios, ainakan-watchos, ainakan-tvos]
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Download ainakan-gadget for macOS/x86_64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-macos-x86_64
          path: macos-x86_64/
      - name: Download ainakan-gadget for macOS/arm64(e)
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-macos-arm64e
          path: macos-arm64e/
      - name: Create universal ainakan-gadget for macOS
        run: |
          lipo \
              macos-x86_64/ainakan-gadget.dylib \
              macos-arm64e/ainakan-gadget.dylib \
              -create -output ainakan-gadget-macos-universal.dylib
          install_name_tool \
              -id @executable_path/../Frameworks/AinakanGadget.dylib \
              ainakan-gadget-macos-universal.dylib
          codesign \
              -f -s "$MACOS_CERTID" \
              ainakan-gadget-macos-universal.dylib
      - name: Compress universal ainakan-gadget for macOS
        run: xz -T 0 ainakan-gadget-macos-universal.dylib
      - name: Upload universal ainakan-gadget for macOS
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-macos-universal
          path: ainakan-gadget-macos-universal.dylib.xz
      - name: Download ainakan-gadget for iOS/arm64(e)
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-ios-arm64e
          path: ios-arm64e/
      - name: Create universal ainakan-gadget for iOS
        run: |
          mv ios-arm64e/ainakan-gadget.dylib ainakan-gadget-ios-universal.dylib
          install_name_tool \
              -id @executable_path/Frameworks/AinakanGadget.dylib \
              ainakan-gadget-ios-universal.dylib
          codesign \
              -f -s "$IOS_CERTID" \
              ainakan-gadget-ios-universal.dylib
      - name: Compress universal ainakan-gadget for iOS
        run: |
          gzip -k ainakan-gadget-ios-universal.dylib
          xz -T 0 ainakan-gadget-ios-universal.dylib
      - name: Upload universal ainakan-gadget for iOS (gz)
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-ios-universal-gz
          path: ainakan-gadget-ios-universal.dylib.gz
      - name: Upload universal ainakan-gadget for iOS (xz)
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-ios-universal-xz
          path: ainakan-gadget-ios-universal.dylib.xz
      - name: Download ainakan-gadget for iOS/x86_64-simulator
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-ios-x86_64-simulator
          path: ios-x86_64-simulator/
      - name: Download ainakan-gadget for iOS/arm64-simulator
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-ios-arm64-simulator
          path: ios-arm64-simulator/
      - name: Create universal ainakan-gadget for iOS Simulator
        run: |
          lipo \
              ios-x86_64-simulator/ainakan-gadget.dylib \
              ios-arm64-simulator/ainakan-gadget.dylib \
              -create -output ainakan-gadget-ios-simulator-universal.dylib
          install_name_tool \
              -id @executable_path/Frameworks/AinakanGadget.dylib \
              ainakan-gadget-ios-simulator-universal.dylib
          codesign \
              -f -s "$IOS_CERTID" \
              ainakan-gadget-ios-simulator-universal.dylib
      - name: Compress universal ainakan-gadget for iOS Simulator
        run: xz -T 0 ainakan-gadget-ios-simulator-universal.dylib
      - name: Upload universal ainakan-gadget for iOS Simulator
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-ios-simulator-universal
          path: ainakan-gadget-ios-simulator-universal.dylib.xz
      - name: Download ainakan-gadget for watchOS/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-watchos-arm64
          path: watchos-arm64/
      - name: Download ainakan-gadget for watchOS/arm64-simulator
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-watchos-arm64-simulator
          path: watchos-arm64-simulator/
      - name: Package ainakan-gadget for watchOS
        run: |
          for arch in arm64 arm64-simulator; do
            cp watchos-$arch/ainakan-gadget.dylib ainakan-gadget-watchos-$arch.dylib
            install_name_tool \
                -id @executable_path/Frameworks/AinakanGadget.dylib \
                ainakan-gadget-watchos-$arch.dylib
            codesign \
                -f -s "$WATCHOS_CERTID" \
                ainakan-gadget-watchos-$arch.dylib
            xz -T 0 ainakan-gadget-watchos-$arch.dylib
          done
      - name: Upload ainakan-gadget for watchOS/arm64
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-watchos-arm64
          path: ainakan-gadget-watchos-arm64.dylib.xz
      - name: Upload ainakan-gadget for watchOS/arm64-simulator
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-watchos-arm64-simulator
          path: ainakan-gadget-watchos-arm64-simulator.dylib.xz
      - name: Download ainakan-gadget for tvOS/arm64
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-tvos-arm64
          path: tvos-arm64/
      - name: Download ainakan-gadget for tvOS/arm64-simulator
        uses: actions/download-artifact@v4
        with:
          name: ainakan-gadget-tvos-arm64-simulator
          path: tvos-arm64-simulator/
      - name: Package ainakan-gadget for tvOS
        run: |
          for arch in arm64 arm64-simulator; do
            cp tvos-$arch/ainakan-gadget.dylib ainakan-gadget-tvos-$arch.dylib
            install_name_tool \
                -id @executable_path/Frameworks/AinakanGadget.dylib \
                ainakan-gadget-tvos-$arch.dylib
            codesign \
                -f -s "$TVOS_CERTID" \
                ainakan-gadget-tvos-$arch.dylib
            xz -T 0 ainakan-gadget-tvos-$arch.dylib
          done
      - name: Upload ainakan-gadget for tvOS/arm64
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-tvos-arm64
          path: ainakan-gadget-tvos-arm64.dylib.xz
      - name: Upload ainakan-gadget for tvOS/arm64-simulator
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-ainakan-gadget-tvos-arm64-simulator
          path: ainakan-gadget-tvos-arm64-simulator.dylib.xz

  package-windows:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-windows
    strategy:
      matrix:
        arch: [x86, x86_64, arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-windows-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-windows-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-windows-${{ matrix.arch }}
      - name: Package ainakan-server
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-server-windows-${{ matrix.arch }}
      - name: Package ainakan-portal
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-portal-windows-${{ matrix.arch }}
      - name: Package ainakan-inject
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-inject-windows-${{ matrix.arch }}
      - name: Package ainakan-gadget
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-gadget-windows-${{ matrix.arch }}
      - name: Package .NET bindings
        if: matrix.arch != 'arm64'
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-clr-windows-${{ matrix.arch }}
      - name: Package QML bindings
        if: matrix.arch == 'x86_64'
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-qml-windows-${{ matrix.arch }}

  package-windows-sfx:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-windows
    strategy:
      matrix:
        arch: [x86, x86_64]
    runs-on: windows-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-sfx
        with:
          name: ainakan-gum-devkit-windows-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-sfx
        with:
          name: ainakan-gumjs-devkit-windows-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-sfx
        with:
          name: ainakan-core-devkit-windows-${{ matrix.arch }}

  package-macos:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-macos
    strategy:
      matrix:
        arch: [x86_64, arm64, arm64e]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-macos-${{ matrix.arch }}
      - name: Package gum-graft
        if: matrix.arch != 'arm64e'
        uses: ./.github/actions/package-artifact-file
        with:
          name: gum-graft-macos-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-macos-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-macos-${{ matrix.arch }}
      - name: Package ainakan-server
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-server-macos-${{ matrix.arch }}
      - name: Package ainakan-portal
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-portal-macos-${{ matrix.arch }}
      - name: Package ainakan-inject
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-inject-macos-${{ matrix.arch }}
      - name: Package QML bindings
        if: matrix.arch == 'x86_64'
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-qml-macos-${{ matrix.arch }}

  package-linux:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-linux
    strategy:
      matrix:
        arch: [x86, x86_64, x86_64-musl, armhf, armhf-musl, armbe8, arm64, arm64be, arm64-musl, mips, mipsel, mips64, mips64el]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-linux-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-linux-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-linux-${{ matrix.arch }}
      - name: Package ainakan-server
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-server-linux-${{ matrix.arch }}
      - name: Package ainakan-portal
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-portal-linux-${{ matrix.arch }}
      - name: Package ainakan-gadget
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-gadget-linux-${{ matrix.arch }}
      - name: Package ainakan-inject
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-inject-linux-${{ matrix.arch }}
      - name: Package QML bindings
        if: matrix.arch == 'x86_64'
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-qml-linux-${{ matrix.arch }}

  package-ios:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-ios
    strategy:
      matrix:
        arch: [arm64, arm64e, x86_64-simulator, arm64-simulator]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-ios-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-ios-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-ios-${{ matrix.arch }}
      - name: Package ainakan-portal
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-portal-ios-${{ matrix.arch }}

  package-watchos:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-watchos
    strategy:
      matrix:
        arch: [arm64, arm64-simulator]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-watchos-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-watchos-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-watchos-${{ matrix.arch }}

  package-tvos:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-tvos
    strategy:
      matrix:
        arch: [arm64, arm64-simulator]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-tvos-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-tvos-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-tvos-${{ matrix.arch }}

  package-android:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-android
    strategy:
      matrix:
        arch: [x86, x86_64, arm, arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-android-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-android-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-android-${{ matrix.arch }}
      - name: Package ainakan-server
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-server-android-${{ matrix.arch }}
      - name: Package ainakan-portal
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-portal-android-${{ matrix.arch }}
      - name: Package ainakan-gadget
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-gadget-android-${{ matrix.arch }}
      - name: Package ainakan-inject
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-inject-android-${{ matrix.arch }}

  package-qnx:
    if: startsWith(github.ref, 'refs/tags/')
    needs: ainakan-qnx
    strategy:
      matrix:
        arch: [armeabi]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Package Gum devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gum-devkit-qnx-${{ matrix.arch }}
      - name: Package GumJS devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-gumjs-devkit-qnx-${{ matrix.arch }}
      - name: Package Core devkit
        uses: ./.github/actions/package-artifact-files-as-tarball
        with:
          name: ainakan-core-devkit-qnx-${{ matrix.arch }}
      - name: Package ainakan-server
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-server-qnx-${{ matrix.arch }}
      - name: Package ainakan-portal
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-portal-qnx-${{ matrix.arch }}
      - name: Package ainakan-gadget
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-gadget-qnx-${{ matrix.arch }}
      - name: Package ainakan-inject
        uses: ./.github/actions/package-artifact-file
        with:
          name: ainakan-inject-qnx-${{ matrix.arch }}

  ainakan-windows-intel:
    needs: sdk-windows
    strategy:
      matrix:
        include:
          - { arch: x86,    sys: MINGW32,    pkg: 'mingw-w64-i686-gcc'            }
          - { arch: x86_64, sys: MINGW64,    pkg: 'mingw-w64-x86_64-gcc'          }
      fail-fast: false
    runs-on: windows-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-windows-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
          architecture: ${{ matrix.arch == 'x86_64' && 'x64' || matrix.arch }}
      - name: Install MinGW toolchain for cgo support
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          install: ${{ matrix.pkg }}
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Install Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.AINAKAN_COMPILER_MOD }}
          cache-dependency-path: ${{ env.AINAKAN_COMPILER_MOD }}
      - name: Install Qt
        if: matrix.arch == 'x86_64'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          cache: true
          setup-python: false
      - name: Configure
        run: >-
          .\configure
          --prefix=$Env:AINAKAN_PREFIX
          --host=windows-${{ matrix.arch }}
          --enable-gadget
          --enable-server
          --enable-portal
          --enable-inject
          --
          "-Dainakan_qml=auto"
          "-Dainakan-gum:devkits=gum,gumjs"
          "-Dainakan-core:compiler_backend=enabled"
          "-Dainakan-core:devkits=core"
        env:
          MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
      - name: Compile
        run: .\make
      - name: Install
        run: .\make install
      - name: Upload components needed for emulation on arm64
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-emulation-windows
          path: |
            build/subprojects/ainakan-core/src/ainakan-helper.exe
            build/subprojects/ainakan-core/lib/agent/ainakan-agent.dll
            build/subprojects/ainakan-core/compat/ainakan-helper.exe
            build/subprojects/ainakan-core/compat/ainakan-agent.dll
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-server.exe
      - name: Upload ainakan-portal
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-portal.exe
      - name: Upload ainakan-inject
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-inject.exe
      - name: Upload 32-bit ainakan-gadget
        if: matrix.arch != 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/32/ainakan-gadget.dll
      - name: Upload 64-bit ainakan-gadget
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/64/ainakan-gadget.dll
      - name: Package Python bindings
        run: |
          $Env:AINAKAN_EXTENSION = "$Env:AINAKAN_PREFIX\lib\site-packages\ainakan\_ainakan.pyd"
          cd subprojects\ainakan-python
          pip wheel -w "$Env:AINAKAN_PREFIX\wheels" --no-deps .
      - name: Upload Python bindings
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-python-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/wheels/*.whl
      - name: Build Node.js bindings
        if: matrix.arch == 'x86_64'
        run: |
          $installdir = "$Env:AINAKAN_PREFIX\prebuilds"
          $Env:AINAKAN_DEPS = "$pwd\deps"
          $Env:PKG_CONFIG_PATH = "$Env:AINAKAN_PREFIX\lib\pkgconfig"
          function Run {
            param(
              [Parameter(Mandatory)]
              [string] $FilePath,
              [Parameter(ValueFromRemainingArguments = $true)]
              [string[]] $Argv
            )
            $p = Start-Process -FilePath $FilePath -ArgumentList $Argv -NoNewWindow -Wait -PassThru
            if ($p.ExitCode -ne 0) {
              throw "'$FilePath $($Argv -join ' ')' failed with exit status $($p.ExitCode)"
            }
          }
          Run python .\tools\ensure-submodules.py ainakan-node
          cd subprojects\ainakan-node
          Run npm.cmd version $Env:AINAKAN_VERSION
          Run .\configure `
              --prefix=$Env:AINAKAN_PREFIX `
              --host=windows-${{ matrix.arch }}
          Run .\make prebuild
          New-Item -ItemType Directory -Path $installdir
          Copy-Item .\build\*.tar.gz -Destination $installdir
      - name: Upload Node.js bindings
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-node-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/prebuilds/*.tar.gz
      - name: Build .NET bindings
        run: >-
          Remove-Item build -Recurse
          && .\configure
          --prefix=$Env:AINAKAN_PREFIX
          --host=windows-${{ matrix.arch }}-md
          --enable-ainakan-clr
          --disable-ainakan-python
          --disable-ainakan-tools
          --
          "-Dainakan-core:compiler_backend=disabled"
          && .\make install
      - name: Upload .NET bindings
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-clr-windows-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/Ainakan.dll
      - name: Upload QML bindings
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-qml-windows-${{ matrix.arch }}
          path: |
            ${{ env.AINAKAN_PREFIX }}/lib/qml/
            !*.lib
            !*.pdb

  ainakan-windows:
    needs: ainakan-windows-intel
    runs-on: windows-11-arm
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-windows-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
          architecture: arm64
      - name: Install MinGW toolchain for cgo support
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: CLANGARM64
          install: mingw-w64-clang-aarch64-clang
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Install Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.AINAKAN_COMPILER_MOD }}
          cache-dependency-path: ${{ env.AINAKAN_COMPILER_MOD }}
      - name: Download emulation components
        uses: actions/download-artifact@v4
        with:
          name: ainakan-core-emulation-windows
          path: emulation/
      - name: Configure
        run: |
          $helperModern = (Resolve-Path "emulation/src/ainakan-helper.exe").Path
          $agentModern = (Resolve-Path "emulation/lib/agent/ainakan-agent.dll").Path
          $helperLegacy = (Resolve-Path "emulation/compat/ainakan-helper.exe").Path
          $agentLegacy = (Resolve-Path "emulation/compat/ainakan-agent.dll").Path

          .\configure `
            --prefix=$Env:AINAKAN_PREFIX `
            --host=windows-arm64 `
            --enable-gadget `
            --enable-server `
            --enable-portal `
            --enable-inject `
            -- `
            "-Dainakan_qml=auto" `
            "-Dainakan-gum:devkits=gum,gumjs" `
            "-Dainakan-core:compiler_backend=enabled" `
            "-Dainakan-core:devkits=core" `
            "-Dainakan-core:helper_emulated_modern=$helperModern" `
            "-Dainakan-core:agent_emulated_modern=$agentModern" `
            "-Dainakan-core:helper_emulated_legacy=$helperLegacy" `
            "-Dainakan-core:agent_emulated_legacy=$agentLegacy"
        env:
          MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
      - name: Compile
        run: .\make
      - name: Install
        run: .\make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-server.exe
      - name: Upload ainakan-portal
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-portal.exe
      - name: Upload ainakan-inject
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-inject.exe
      - name: Upload ainakan-gadget
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/64/ainakan-gadget.dll
      - name: Package Python bindings
        run: |
          $Env:AINAKAN_EXTENSION = "$Env:AINAKAN_PREFIX\lib\site-packages\ainakan\_ainakan.pyd"
          cd subprojects\ainakan-python
          pip wheel -w "$Env:AINAKAN_PREFIX\wheels" --no-deps .
      - name: Upload Python bindings
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-python-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/wheels/*.whl
      - name: Build Node.js bindings
        run: |
          $installdir = "$Env:AINAKAN_PREFIX\prebuilds"
          $Env:AINAKAN_DEPS = "$pwd\deps"
          $Env:PKG_CONFIG_PATH = "$Env:AINAKAN_PREFIX\lib\pkgconfig"
          function Run {
            param(
              [Parameter(Mandatory)]
              [string] $FilePath,
              [Parameter(ValueFromRemainingArguments = $true)]
              [string[]] $Argv
            )
            $p = Start-Process -FilePath $FilePath -ArgumentList $Argv -NoNewWindow -Wait -PassThru
            if ($p.ExitCode -ne 0) {
              throw "'$FilePath $($Argv -join ' ')' failed with exit status $($p.ExitCode)"
            }
          }
          Run python .\tools\ensure-submodules.py ainakan-node
          cd subprojects\ainakan-node
          Run npm.cmd version $Env:AINAKAN_VERSION
          Run .\configure `
              --prefix=$Env:AINAKAN_PREFIX `
              --host=windows-arm64
          Run .\make prebuild
          New-Item -ItemType Directory -Path $installdir
          Copy-Item .\build\*.tar.gz -Destination $installdir
      - name: Upload Node.js bindings
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-node-windows-arm64
          path: ${{ env.AINAKAN_PREFIX }}/prebuilds/*.tar.gz

  ainakan-macos:
    needs: sdk-macos
    strategy:
      matrix:
        arch: [x86_64, arm64, arm64e]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Install Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.AINAKAN_COMPILER_MOD }}
          cache-dependency-path: ${{ env.AINAKAN_COMPILER_MOD }}
      - name: Install Qt
        if: matrix.arch != 'arm64e'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          cache: true
          setup-python: false
      - name: Configure
        run: >-
          ./configure
          "--prefix=$AINAKAN_PREFIX"
          --host=macos-${{ matrix.arch }}
          --enable-gadget
          --enable-server
          --enable-portal
          --enable-inject
          --enable-ainakan-python
          --
          -Dainakan_qml=${{ matrix.arch != 'arm64e' && 'enabled' || 'disabled' }}
          -Dainakan-gum:graft_tool=enabled
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:compiler_backend=${{ matrix.arch != 'arm64e' && 'enabled' || 'disabled' }}
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload gum-graft
        if: matrix.arch != 'arm64e'
        uses: actions/upload-artifact@v4
        with:
          name: gum-graft-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/gum-graft
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-server
      - name: Upload ainakan-portal
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-portal
      - name: Upload ainakan-inject
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-inject
      - name: Upload ainakan-gadget
        if: matrix.arch != 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/ainakan-gadget.dylib
      - name: Package Python bindings
        run: |
          export AINAKAN_EXTENSION=$(find "$AINAKAN_PREFIX" -name _ainakan.abi3.so)
          case ${{ matrix.arch }} in
            x86_64)
              platform=macosx-10.13-x86_64
              ;;
            arm64*)
              platform=macosx-11.0-arm64
              ;;
          esac
          export _PYTHON_HOST_PLATFORM=$platform
          cd subprojects/ainakan-python
          pip wheel -w "$AINAKAN_PREFIX/wheels" --no-deps .
      - name: Upload Python bindings
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-python-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/wheels/*.whl
      - name: Build Node.js bindings
        if: matrix.arch != 'arm64e'
        run: |
          installdir=$AINAKAN_PREFIX/prebuilds
          export AINAKAN_DEPS=$PWD/deps
          export PKG_CONFIG_PATH=$AINAKAN_PREFIX/lib/pkgconfig
          python tools/ensure-submodules.py ainakan-node
          cd subprojects/ainakan-node
          npm version $AINAKAN_VERSION
          ./configure \
              "--prefix=$AINAKAN_PREFIX" \
              --host=macos-${{ matrix.arch }}
          make prebuild
          mkdir "$installdir"
          cp build/*.tar.gz "$installdir"
        shell: zsh {0}
      - name: Upload Node.js bindings
        if: matrix.arch != 'arm64e'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-node-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/prebuilds/*.tar.gz
      - name: Upload QML bindings
        if: matrix.arch != 'arm64e'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-qml-macos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/qml/

  ainakan-linux:
    needs: sdk-linux
    strategy:
      matrix:
        arch: [x86, x86_64, x86_64-musl, armhf, armhf-musl, armbe8, arm64, arm64be, arm64-musl, mips, mipsel, mips64, mips64el]
      fail-fast: false
    runs-on: ubuntu-latest
    container: ghcr.io/ainakan/x-tools-linux-${{ matrix.arch }}:latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Install Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.AINAKAN_COMPILER_MOD }}
          cache-dependency-path: ${{ env.AINAKAN_COMPILER_MOD }}
      - name: Configure qemu-user
        if: ${{ !startsWith(matrix.arch, 'x86') }}
        run: echo "AINAKAN_QEMU_SYSROOT=/opt/x-tools/$XTOOLS_HOST/$XTOOLS_HOST/sysroot" >> $GITHUB_ENV
      - name: Prepare environment for installing Qt
        if: matrix.arch == 'x86_64'
        run: |
          apt-get update
          apt-get install -y sudo
          echo "PIP_BREAK_SYSTEM_PACKAGES=1" >> $GITHUB_ENV
      - name: Install Qt
        if: matrix.arch == 'x86_64'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          cache: true
          setup-python: false
      - name: Configure
        run: >-
          ./configure
          "--prefix=$AINAKAN_PREFIX"
          --host=$XTOOLS_HOST
          --enable-gadget
          --enable-server
          --enable-portal
          --enable-inject
          --enable-ainakan-python
          --
          -Dlibdir=lib
          -Dainakan_qml=${{ matrix.arch == 'x86_64' && 'enabled' || 'disabled' }}
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:compiler_backend=${{ !(startsWith(matrix.arch, 'mips') || matrix.arch == 'armbe8' || matrix.arch == 'arm64be') && 'enabled' || 'disabled' }}
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-server
      - name: Upload ainakan-portal
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-portal
      - name: Upload ainakan-inject
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-inject
      - name: Upload 32-bit ainakan-gadget
        if: ${{ !contains(matrix.arch, '64') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/32/ainakan-gadget.so
      - name: Upload 64-bit ainakan-gadget
        if: ${{ contains(matrix.arch, '64') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/64/ainakan-gadget.so
      - name: Package Python bindings
        run: |
          export AINAKAN_EXTENSION=$(find "$AINAKAN_PREFIX" -name _ainakan.abi3.so)
          case ${{ matrix.arch }} in
            *-musl)
              py_oses=(musllinux_1_1)
              ;;
            x86*)
              py_oses=(manylinux_2_5 manylinux1)
              ;;
            arm*|ppc*|s390x)
              py_oses=(manylinux_2_17 manylinux2014)
              ;;
            *)
              py_oses=(manylinux_2_5)
              ;;
          esac
          ainakan_arch=$(echo "${{ matrix.arch }}" | cut -f1 -d"-")
          case $ainakan_arch in
            x86)
              py_arch=i686
              ;;
            armhf)
              py_arch=armv7l
              ;;
            arm64)
              py_arch=aarch64
              ;;
            *)
              py_arch=$ainakan_arch
              ;;
          esac
          cd subprojects/ainakan-python
          export _PYTHON_HOST_PLATFORM=linux-$py_arch
          for py_os in "${py_oses[@]}"; do
            echo "plat_name = ${py_os}_${py_arch}" >> setup.cfg
            pip wheel -w "$AINAKAN_PREFIX/wheels" --no-deps .
            git checkout setup.cfg
          done
        shell: bash
      - name: Upload Python bindings
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-python-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/wheels/*.whl
      - name: Build Node.js bindings
        if: ${{ !(startsWith(matrix.arch, 'mips') || endsWith(matrix.arch, '-musl') || matrix.arch == 'armbe8' || matrix.arch == 'arm64be') }}
        run: |
          installdir=$AINAKAN_PREFIX/prebuilds
          export AINAKAN_DEPS=$PWD/deps
          export PKG_CONFIG_PATH=$AINAKAN_PREFIX/lib/pkgconfig
          python tools/ensure-submodules.py ainakan-node
          cd subprojects/ainakan-node
          npm version $AINAKAN_VERSION
          ./configure \
              "--prefix=$AINAKAN_PREFIX" \
              --host=$XTOOLS_HOST
          make prebuild
          mkdir "$installdir"
          cp build/*.tar.gz "$installdir"
        shell: bash
      - name: Upload Node.js bindings
        if: ${{ !(startsWith(matrix.arch, 'mips') || endsWith(matrix.arch, '-musl') || matrix.arch == 'armbe8' || matrix.arch == 'arm64be') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-node-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/prebuilds/*.tar.gz
      - name: Upload QML bindings
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-qml-linux-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/qml/

  ainakan-ios:
    needs: [sdk-macos, sdk-ios]
    strategy:
      matrix:
        arch: [arm64, arm64e, x86_64-simulator, arm64-simulator]
      fail-fast: false
    runs-on: macos-latest
    env:
      XCODE11: /Applications/Xcode_11.7.app
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Install Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.AINAKAN_COMPILER_MOD }}
          cache-dependency-path: ${{ env.AINAKAN_COMPILER_MOD }}
      - name: Configure
        run: >-
          ./configure
          --prefix=/usr
          --host=ios-${{ matrix.arch }}
          --enable-portal
          --
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:compiler_backend=${{ matrix.arch != 'arm64e' && 'enabled' || 'disabled' }}
          -Dainakan-core:assets=installed
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: DESTDIR="$AINAKAN_PREFIX" make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        if: ${{ matrix.arch != 'arm64' && !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/bin/ainakan-server
      - name: Upload ainakan-portal
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/bin/ainakan-portal
      - name: Upload ainakan-inject
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/bin/ainakan-inject
      - name: Upload ainakan-helper
        if: ${{ matrix.arch != 'arm64' && !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-helper-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/ainakan-helper
      - name: Upload ainakan-agent
        if: ${{ matrix.arch != 'arm64' && !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-agent-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/ainakan-agent.dylib
      - name: Upload ainakan-gadget
        if: matrix.arch != 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-ios-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/ainakan-gadget.dylib

  ainakan-watchos:
    needs: [sdk-macos, sdk-watchos]
    strategy:
      matrix:
        arch: [arm64, arm64-simulator]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Configure
        run: >-
          ./configure
          "--prefix=$AINAKAN_PREFIX"
          --host=watchos-${{ matrix.arch }}
          --
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-watchos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-watchos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-watchos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-gadget
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-watchos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/ainakan-gadget.dylib

  ainakan-tvos:
    needs: [sdk-macos, sdk-tvos]
    strategy:
      matrix:
        arch: [arm64, arm64-simulator]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Configure
        run: >-
          ./configure
          --prefix=/usr
          --host=tvos-${{ matrix.arch }}
          --enable-portal
          --
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:assets=installed
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: DESTDIR="$AINAKAN_PREFIX" make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/bin/ainakan-server
      - name: Upload ainakan-portal
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/bin/ainakan-portal
      - name: Upload ainakan-inject
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/bin/ainakan-inject
      - name: Upload ainakan-helper
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-helper-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/ainakan-helper
      - name: Upload ainakan-agent
        if: ${{ !endsWith(matrix.arch, '-simulator') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-agent-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/ainakan-agent.dylib
      - name: Upload ainakan-gadget
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-tvos-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/usr/lib/ainakan/ainakan-gadget.dylib

  ainakan-android:
    needs: [sdk-linux, sdk-android-32, sdk-android-64]
    strategy:
      matrix:
        arch: [x86, x86_64, arm, arm64]
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Grab ainakan-core
        run: python tools/ensure-submodules.py ainakan-core
      - name: Install Go toolchain
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.AINAKAN_COMPILER_MOD }}
          cache-dependency-path: ${{ env.AINAKAN_COMPILER_MOD }}
      - name: Set up NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: false
      - name: Add ANDROID_NDK_ROOT to environment
        run: echo "ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
      - name: Configure
        run: >-
          ./configure
          "--prefix=$AINAKAN_PREFIX"
          --host=android-${{ matrix.arch }}
          --enable-portal
          --
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:compiler_backend=enabled
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-server
      - name: Upload ainakan-portal
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-portal
      - name: Upload ainakan-inject
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-inject
      - name: Upload 32-bit ainakan-gadget
        if: ${{ !contains(matrix.arch, '64') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/32/ainakan-gadget.so
      - name: Upload 64-bit ainakan-gadget
        if: ${{ contains(matrix.arch, '64') }}
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-android-${{ matrix.arch }}
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/64/ainakan-gadget.so

  ainakan-qnx:
    runs-on: ubuntu-latest
    needs: sdk-linux
    container: ghcr.io/ainakan/qnx-tools:latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Add CFLAGS to environment
        run: echo "CFLAGS=\"--sysroot=$QNX_TARGET/armle-v7\"" >> $GITHUB_ENV
      - name: Roll SDK
        run: releng/deps.py roll sdk arm-unknown-nto-qnx6.5.0eabi
      - name: Configure
        run: >-
          ./configure
          "--prefix=$AINAKAN_PREFIX"
          --host=arm-unknown-nto-qnx6.5.0eabi
          --enable-portal
          --
          -Dainakan-gum:devkits=gum,gumjs
          -Dainakan-core:devkits=core
      - name: Compile
        run: make
      - name: Install
        run: make install
      - name: Upload Gum devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gum-devkit-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gum/
      - name: Upload GumJS devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gumjs-devkit-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/gumjs/
      - name: Upload Core devkit
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-core-devkit-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/devkits/core/
      - name: Upload ainakan-server
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-server-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-server
      - name: Upload ainakan-portal
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-portal-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-portal
      - name: Upload ainakan-inject
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-inject-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/bin/ainakan-inject
      - name: Upload ainakan-gadget
        uses: actions/upload-artifact@v4
        with:
          name: ainakan-gadget-qnx-armeabi
          path: ${{ env.AINAKAN_PREFIX }}/lib/ainakan/32/ainakan-gadget.so

  toolchain-windows:
    strategy:
      matrix:
        arch: [x86, arm64]
      fail-fast: false
    runs-on: ${{ matrix.arch == 'arm64' && 'windows-11-arm' || 'windows-latest' }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-windows-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll toolchain
        run: python releng\deps.py roll toolchain windows-${{ matrix.arch }}

  sdk-windows:
    needs: toolchain-windows
    strategy:
      matrix:
        arch: [x86, x86_64, arm64]
        config: [md, mdd, mt, mtd]
      fail-fast: false
    runs-on: ${{ matrix.arch == 'arm64' && 'windows-11-arm' || 'windows-latest' }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-windows-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll SDK
        run: python releng\deps.py roll sdk windows-${{ matrix.arch }}-${{ matrix.config }} --activate

  toolchain-macos:
    strategy:
      matrix:
        arch: [x86_64, arm64]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll toolchain
        run: releng/deps.py roll toolchain macos-${{ matrix.arch }}

  sdk-macos:
    needs: toolchain-macos
    strategy:
      matrix:
        arch: [x86_64, arm64, arm64e]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          keychain-password: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll SDK
        run: releng/deps.py roll sdk macos-${{ matrix.arch }} --activate

  sdk-ios:
    needs: toolchain-macos
    strategy:
      matrix:
        arch: [arm64, arm64e, x86_64-simulator, arm64-simulator]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll SDK
        run: releng/deps.py roll sdk ios-${{ matrix.arch }} --activate

  sdk-watchos:
    needs: toolchain-macos
    strategy:
      matrix:
        arch: [arm64, arm64-simulator]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll SDK
        run: releng/deps.py roll sdk watchos-${{ matrix.arch }} --activate

  sdk-tvos:
    needs: toolchain-macos
    strategy:
      matrix:
        arch: [arm64, arm64-simulator]
      fail-fast: false
    runs-on: macos-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-macos-env
        with:
          certificates-p12: ${{ secrets.APPLE_CERTIFICATES_P12 }}
          certificates-password: ${{ secrets.APPLE_CERTIFICATES_PASSWORD }}
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll SDK
        run: releng/deps.py roll sdk tvos-${{ matrix.arch }} --activate

  toolchain-linux:
    strategy:
      matrix:
        arch: [x86, x86_64, x86_64-musl, armhf, armhf-musl, armbe8, arm64, arm64be, arm64beilp32, arm64-musl]
      fail-fast: false
    runs-on: ubuntu-latest
    container: ghcr.io/ainakan/x-tools-linux-${{ matrix.arch }}:latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Roll toolchain
        run: releng/deps.py roll toolchain $XTOOLS_HOST

  sdk-linux:
    needs: toolchain-linux
    strategy:
      matrix:
        arch: [x86, x86_64, x86_64-musl, armhf, armhf-musl, armbe8, arm64, arm64be, arm64beilp32, arm64-musl, mips, mipsel, mips64, mips64el]
      fail-fast: false
    runs-on: ubuntu-latest
    container: ghcr.io/ainakan/x-tools-linux-${{ matrix.arch }}:latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Set AINAKAN_CAN_RUN_HOST_BINARIES
        if: ${{ matrix.arch == 'x86' }}
        run: echo "AINAKAN_CAN_RUN_HOST_BINARIES=yes" >> $GITHUB_ENV
      - name: Configure qemu-user
        if: ${{ !startsWith(matrix.arch, 'x86') }}
        run: echo "AINAKAN_QEMU_SYSROOT=/opt/x-tools/$XTOOLS_HOST/$XTOOLS_HOST/sysroot" >> $GITHUB_ENV
      - name: Roll SDK
        run: releng/deps.py roll sdk $XTOOLS_HOST --activate

  sdk-android-32:
    needs: toolchain-linux
    strategy:
      matrix:
        arch: [x86, arm]
      fail-fast: false
    runs-on: ubuntu-latest
    container: ghcr.io/ainakan/x-tools-linux-x86:latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Set up NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: false
      - name: Roll SDK
        run: releng/deps.py roll sdk android-${{ matrix.arch }} --build=$XTOOLS_HOST --activate
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}

  sdk-android-64:
    needs: toolchain-linux
    strategy:
      matrix:
        arch: [x86_64, arm64]
      fail-fast: false
    runs-on: ubuntu-latest
    container: ghcr.io/ainakan/x-tools-linux-x86_64:latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/setup-linux-env
        with:
          aws-access-key-id: ${{ secrets.S3_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_SECRET_KEY }}
          cloudflare-email: ${{ secrets.CF_EMAIL }}
          cloudflare-token: ${{ secrets.CF_TOKEN }}
      - name: Set up NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: false
      - name: Roll SDK
        run: releng/deps.py roll sdk android-${{ matrix.arch }} --build=$XTOOLS_HOST --activate
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
